<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DayTale - Your Journal. Now.</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Arimo:ital,wght@0,400..700;1,400..700&family=Cal+Sans&family=Syne:wght@400..800&display=swap" rel="stylesheet">

  <style>
    /* Helper for Cal Sans header */
    .cal-sans-regular {
      font-family: "Cal Sans", sans-serif;
      font-weight: 400;
      font-style: normal;
    }

    :root{
      --oxford:#050a30; --kobicha:#5b3a1f; --lion:#c6a575;
      --bg-dark: var(--oxford); --bg-card-dark: rgba(5,10,48,0.60);
      --bg-light:#fefefe; --bg-card-light: rgba(255,255,255,0.94);
      --text-dark:#1f2937; --text-light:#f9fafb; --text-muted:#9ca3af;
      --border-light: rgba(255,255,255,0.14); --border-dark: rgba(0,0,0,0.14);
      --shadow: rgba(0,0,0,0.28); --radius: 18px;
      --focus:#c6a575;
    }

    *{margin:0;padding:0;box-sizing:border-box}

    body{
      font-family:'Arimo', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height:100vh;
      background:
        radial-gradient(circle at 20% 50%, rgba(198,165,117,0.22) 0%, transparent 55%),
        radial-gradient(circle at 80% 15%, rgba(91,58,31,0.22) 0%, transparent 55%),
        var(--bg-dark);
      color:var(--text-light);
      transition:background .35s ease,color .35s ease;
      overflow-x:hidden;
    }
    body.light-mode{
      background:
        radial-gradient(circle at 18% 48%, rgba(198,165,117,0.12) 0%, transparent 55%),
        radial-gradient(circle at 82% 18%, rgba(91,58,31,0.12) 0%, transparent 55%),
        var(--bg-light);
      color:var(--text-dark);
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      .logo, .rotator-line { animation: none !important; transition: none !important; }
    }

    .container{max-width:1200px;margin:0 auto;padding:2rem;display:flex;flex-direction:column;gap:2.2rem}
    .header{text-align:center}
    .logo-container{display:flex;align-items:center;justify-content:center;gap:.8rem;margin-bottom:.35rem}
    .logo{width:56px;height:56px;border-radius:14px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid var(--border-dark);box-shadow:0 10px 30px var(--shadow);animation:float 3s ease-in-out infinite}
    .logo img{width:100%;height:100%;object-fit:cover;display:block}
    .app-title{font-family:"Cal Sans","Syne",system-ui,sans-serif;font-size:2.6rem;font-weight:800;letter-spacing:.2px;background:linear-gradient(135deg, var(--lion), var(--kobicha));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}

    .rotator{position:relative;height:2.2rem;margin-top:.3rem;overflow:hidden}
    .rotator-line{position:absolute;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .5s, transform .5s;color:var(--text-muted);font-size:1.05rem;white-space:nowrap}
    .rotator-line.active{opacity:1;transform:translate(-50%,0)}

    .workspace{display:grid;grid-template-columns:1fr 1fr;gap:1.4rem;min-height:68vh}
    .panel{background:var(--bg-card-dark);backdrop-filter:blur(18px);border-radius:var(--radius);border:1px solid var(--border-light);padding:1.6rem;display:flex;flex-direction:column;gap:1rem;transition:transform .2s ease, box-shadow .2s ease;box-shadow:0 18px 52px rgba(0,0,0,.32)}
    .light-mode .panel{background:var(--bg-card-light);border:1px solid var(--border-dark);box-shadow:0 18px 52px rgba(0,0,0,.10)}
    .panel:hover{transform:translateY(-2px);box-shadow:0 22px 64px rgba(0,0,0,.36)}
    .light-mode .panel:hover{box-shadow:0 22px 64px rgba(0,0,0,.16)}

    .panel-header{display:flex;justify-content:space-between;align-items:center}
    .panel-title{font-size:1.02rem;font-weight:800;color:var(--lion);letter-spacing:.2px}

    .controls{display:flex;gap:.8rem;flex-wrap:wrap;align-items:center}
    .control-group{display:flex;flex-direction:column;gap:.35rem}
    .control-label{font-size:.78rem;font-weight:800;color:var(--text-muted);text-transform:uppercase;letter-spacing:.4px}

    select{
      background:rgba(255,255,255,0.08);border:1px solid var(--border-light);color:var(--text-light);
      padding:.6rem .85rem;border-radius:12px;cursor:pointer;font-family:inherit;font-size:.92rem;
      transition:border-color .15s ease, box-shadow .15s ease;min-width:160px;appearance:none;
      background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position:right .55rem center;background-repeat:no-repeat;background-size:1.25em;padding-right:2.1rem;
    }
    .light-mode select{color:var(--text-dark);background:rgba(0,0,0,0.04);border:1px solid var(--border-dark)}
    select:focus, .btn:focus, textarea:focus { outline:3px solid var(--focus); outline-offset:2px; }

    .btn{border:none;padding:.7rem 1.15rem;border-radius:12px;cursor:pointer;font-family:inherit;font-weight:800;font-size:.92rem;transition:transform .15s ease, box-shadow .15s ease}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .btn-primary{background:linear-gradient(135deg, var(--kobicha), #3f2c13);color:#fefefe;box-shadow:0 6px 18px rgba(91,58,31,.45)}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 10px 26px rgba(91,58,31,.6)}
    .btn-secondary{background:rgba(255,255,255,0.08);color:var(--text-light);border:1px solid var(--border-light)}
    .light-mode .btn-secondary{background:rgba(0,0,0,0.05);color:var(--text-dark);border:1px solid var(--border-dark)}
    .btn-secondary:hover{background:rgba(255,255,255,0.14)}
    .transform-btn{font-size:1.02rem;padding:.9rem 1.4rem;margin-top:.2rem}

    textarea{flex:1;background:rgba(0,0,0,0.22);border:1px solid var(--border-light);border-radius:12px;padding:1.1rem;color:var(--text-light);font-family:inherit;font-size:1rem;resize:none;line-height:1.7;transition:border-color .15s ease, box-shadow .15s ease;min-height:220px}
    .light-mode textarea{background:rgba(255,255,255,0.56);color:var(--text-dark);border:1px solid var(--border-dark)}
    textarea::placeholder{color:#b6b8c3;font-style:italic}

    .save-indicator{font-size:.82rem;color:var(--text-muted);text-align:right;margin-top:.2rem}

    .output{flex:1;overflow-y:auto;color:var(--text-light);line-height:1.85;padding:1.1rem;font-family:inherit;font-size:1.05rem;white-space:pre-wrap;background:rgba(255,255,255,0.03);border:1px solid var(--border-light);border-radius:12px;min-height:220px}
    .light-mode .output{color:#1b1f29;background:rgba(0,0,0,0.03);border:1px solid var(--border-dark)}

    .char-count{font-size:.82rem;color:var(--text-muted);text-align:right}
    .loading{display:none;text-align:center;padding:1.1rem;color:var(--lion);font-style:italic;animation:pulse 1.5s ease-in-out infinite}

    .example-prompts{display:flex;flex-direction:column;gap:.45rem;margin-top:.2rem}
    .example-prompt{background:rgba(198,165,117,.12);border:1px solid rgba(198,165,117,.35);border-radius:10px;padding:.6rem .75rem;font-size:.9rem;cursor:pointer;transition:background .18s ease,color .18s ease;color:#cfcfd8}
    .example-prompt:hover{background:rgba(198,165,117,.2);color:var(--text-light)}
    .light-mode .example-prompt{color:#4a4a4a}
    .light-mode .example-prompt:hover{color:#111}

    .quote-candidates{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.4rem}
    .quote-chip{border:1px dashed rgba(255,255,255,.35);border-radius:999px;padding:.45rem .7rem;font-size:.9rem;cursor:pointer;color:var(--text-light);background:rgba(255,255,255,.06)}
    .quote-chip:hover{background:rgba(255,255,255,.12)}
    .light-mode .quote-chip{color:var(--text-dark);border-color:rgba(0,0,0,.25);background:rgba(0,0,0,.04)}
    .quote-chip.active{border-style:solid}

    .swatch-bar{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .swatch{width:28px;height:28px;border-radius:50%;border:1px solid rgba(255,255,255,.55);cursor:pointer;position:relative;box-shadow:0 1px 6px rgba(0,0,0,.2)}
    .light-mode .swatch{border-color:rgba(0,0,0,.2)}
    .swatch.active{outline:3px solid rgba(198,165,117,.35)}
    .swatch::after{content:attr(data-name);position:absolute;left:50%;top:-26px;transform:translateX(-50%);font-size:.72rem;color:#cbd5e1;background:rgba(0,0,0,.55);padding:.15rem .35rem;border-radius:6px;opacity:0;pointer-events:none;transition:opacity .15s}
    .light-mode .swatch::after{color:#374151;background:rgba(255,255,255,.95);border:1px solid #e5e7eb}
    .swatch:hover::after{opacity:1}

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:50;padding:1rem}
    .modal.open{display:flex}
    .modal-card{background:var(--bg-card-light);color:var(--text-dark);border-radius:16px;padding:1rem;border:1px solid var(--border-dark);max-width:980px;width:100%;display:grid;gap:1rem;grid-template-columns:1fr}
    @media (min-width: 960px){ .modal-card{ grid-template-columns: 1.05fr 1fr; } }
    .modal-left{display:flex;flex-direction:column;gap:.75rem}
    .modal-right{display:flex;flex-direction:column;gap:.75rem}
    .img-preview{width:100%;border-radius:12px;border:1px solid var(--border-dark);background:#fff}
    .modal-actions{display:flex;gap:.6rem;justify-content:flex-end;flex-wrap:wrap}
    .hint{font-size:.85rem;color:#6b7280}
    .edit-area{display:flex;flex-direction:column;gap:.4rem}
    .edit-area textarea{min-height:80px}

    /* Contrast-fixed buttons INSIDE modal */
    .modal-card .btn-secondary{background:#111827;color:#ffffff;border:1px solid #0b1220}
    .modal-card .btn-secondary:hover{background:#0b1220}
    .modal-card .btn-primary{background:linear-gradient(135deg, #5b3a1f, #3f2c13);color:#fff;border:1px solid #3f2c13}

    footer.small-note{text-align:center;color:var(--text-muted);font-size:.8rem;margin-top:.2rem}

    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    @keyframes pulse{0%,100%{opacity:.55}50%{opacity:1}}

    @media (max-width: 860px){
      .workspace{grid-template-columns:1fr;gap:1rem}
      .container{padding:1rem}
      .app-title{font-size:2.2rem}
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header" aria-live="polite">
      <div class="logo-container">
        <div class="logo" title="DayTale">
          <img src="https://i.ibb.co/kVyL1XmY/Gemini-Generated-Image-dvk7kidvk7kidvk7.png" alt="DayTale icon">
        </div>
        <h1 class="app-title">DayTale</h1>
      </div>
      <div class="rotator" aria-hidden="true">
        <div class="rotator-line active">Your Journal. Now.</div>
        <div class="rotator-line">Small notes. Gentle clarity.</div>
        <div class="rotator-line">Breathe. Write. Release.</div>
      </div>
    </header>

    <div class="workspace">
      <!-- Left: input -->
      <div class="panel">
        <div class="panel-header">
          <h3 class="panel-title">Your Raw Notes</h3>
          <div style="display:flex; gap:.5rem; align-items:center;">
            <button class="btn btn-secondary" id="prompt-btn" aria-label="Insert a prompt of the day">‚ú® Prompt of the day</button>
            <button class="btn btn-secondary" id="theme-toggle" aria-label="Toggle light or dark theme">‚òÄÔ∏è Light</button>
          </div>
        </div>

        <div class="controls">
          <div class="control-group">
            <label class="control-label" for="style">Style</label>
            <select id="style" aria-label="Writing style">
              <option value="reflective">Reflective</option>
              <option value="mindful">Mindful</option>
              <option value="therapeutic">Therapeutic</option>
              <option value="narrative">Narrative</option>
              <option value="gratitude">Gratitude</option>
              <option value="snapshot">Snapshot bullets</option>
              <option value="mantra">One-line mantra</option>
            </select>
          </div>
          <div class="control-group">
            <label class="control-label" for="mood">Tone</label>
            <select id="mood" aria-label="Writing tone">
              <option value="calm">Calm</option>
              <option value="compassionate">Compassionate</option>
              <option value="honest">Honest</option>
              <option value="hopeful">Hopeful</option>
              <option value="neutral">Neutral</option>
              <option value="grounded">Grounded</option>
            </select>
          </div>
        </div>

        <textarea id="input" aria-label="Write a few notes about your day" placeholder="A few notes... tired this morning, anxious before the meeting, walked at lunch, felt lighter after talking with a friend, cooked pasta at night"></textarea>
        <div class="char-count" id="char-count">0 characters</div>
        <div class="save-indicator" id="save-indicator" aria-live="polite"></div>

        <button class="btn btn-primary transform-btn" id="transform" aria-label="Create my journal entry">Create my journal entry</button>

        <div class="example-prompts">
          <button class="example-prompt" data-text="slept late, heavy thoughts in the morning, short walk outside helped, got through tasks, texting a friend made me smile" aria-label="Use example prompt 1">
            üí≠ "slept late, heavy thoughts in the morning, short walk helped..."
          </button>
          <button class="example-prompt" data-text="felt overwhelmed, breathing exercise calmed me a bit, lunch in the sun, set boundaries on one task, grateful for quiet evening" aria-label="Use example prompt 2">
            üí≠ "felt overwhelmed, breathing exercise calmed me, grateful for quiet evening"
          </button>
        </div>

        <footer class="small-note">DayTale is for reflection and wellbeing. It is not a substitute for professional care.</footer>
      </div>

      <!-- Right: output -->
      <div class="panel">
        <div class="panel-header">
          <h3 class="panel-title">Your Journal Entry</h3>
          <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
            <div class="swatch-bar" id="swatch-bar" aria-label="Share palette"></div>
            <button class="btn btn-secondary" id="share-btn" style="display:none;" aria-label="Share quote image">üì∏ Share quote</button>
            <button class="btn btn-secondary" id="copy-btn" style="display:none;" aria-label="Copy entry to clipboard">üìã Copy entry</button>
            <button class="btn btn-secondary" id="download-btn" style="display:none;" aria-label="Download entry as text">‚¨áÔ∏è Download .txt</button>
          </div>
        </div>

        <div class="loading" id="loading">Weaving your day into a gentle reflection...</div>
        <div class="output" id="output">
          Your transformed journal entry will appear here after you press "Create my journal entry".
        </div>

        <div id="candidates-wrap" style="display:none;">
          <div class="control-label" style="margin-top:.4rem;">Suggested quotes</div>
          <div class="quote-candidates" id="quote-candidates"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <div class="modal" id="share-modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="share-title">
      <div class="modal-left">
        <h3 id="share-title" style="font-weight:800;">Shareable Quote</h3>
        <p class="hint">Instagram Story size 1080x1920. Edit your quote and preview on the right.</p>

        <div class="edit-area">
          <label class="control-label" for="quote-edit">Quote text</label>
          <textarea id="quote-edit"></textarea>
          <label class="control-label" style="display:flex;gap:.4rem;align-items:center;">
            <input type="checkbox" id="include-logo" checked/> Include DayTale logo
          </label>
          <button class="btn btn-secondary" id="update-preview">Update preview</button>
        </div>

        <div class="modal-actions">
          <button class="btn btn-secondary" id="share-cancel">Close</button>
          <button class="btn btn-secondary" id="share-copyquote">Copy quote</button>
          <button class="btn btn-secondary" id="share-download">Download PNG</button>
          <button class="btn btn-primary" id="share-do">Share</button>
        </div>
      </div>

      <div class="modal-right">
        <img id="share-preview" class="img-preview" alt="Quote preview"/>
      </div>
    </div>
  </div>

  <script>
    // -------------------------
    // CONFIG
    // -------------------------
    const BRAND_ICON_URL = 'https://i.ibb.co/kVyL1XmY/Gemini-Generated-Image-dvk7kidvk7kidvk7.png';

    // -------------------------
    // ELEMENTS
    // -------------------------
    const themeToggle = document.getElementById('theme-toggle');
    const inputEl = document.getElementById('input');
    const styleEl = document.getElementById('style');
    const moodEl = document.getElementById('mood');
    const charCount = document.getElementById('char-count');
    const saveIndicator = document.getElementById('save-indicator');
    const transformBtn = document.getElementById('transform');
    const loading = document.getElementById('loading');
    const output = document.getElementById('output');
    const copyBtn = document.getElementById('copy-btn');
    const downloadBtn = document.getElementById('download-btn');
    const shareBtn = document.getElementById('share-btn');
    const swatchBar = document.getElementById('swatch-bar');
    const candidatesWrap = document.getElementById('candidates-wrap');
    const candidatesEl = document.getElementById('quote-candidates');
    const promptBtn = document.getElementById('prompt-btn');
    const examplePrompts = document.querySelectorAll('.example-prompt');

    // Modal
    const shareModal = document.getElementById('share-modal');
    const modalCard = shareModal.querySelector('.modal-card');
    const sharePreview = document.getElementById('share-preview');
    const shareCancel = document.getElementById('share-cancel');
    const shareDownload = document.getElementById('share-download');
    const shareDo = document.getElementById('share-do');
    const shareCopyQuote = document.getElementById('share-copyquote');
    const quoteEdit = document.getElementById('quote-edit');
    const includeLogoEl = document.getElementById('include-logo');
    const updatePreviewBtn = document.getElementById('update-preview');

    // Subtitle rotator
    const subtitleLines = Array.from(document.querySelectorAll('.rotator-line'));
    let rotIdx = 0;
    setInterval(() => {
      rotIdx = (rotIdx + 1) % subtitleLines.length;
      subtitleLines.forEach((el,i) => el.classList.toggle('active', i === rotIdx));
    }, 3200);

    // Theme
    let isDark = true;
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('light-mode');
      isDark = !isDark;
      themeToggle.textContent = isDark ? '‚òÄÔ∏è Light' : 'üåô Dark';
      localStorage.setItem('daytale-theme', isDark ? 'dark' : 'light');
    });
    (function restoreTheme(){
      const saved = localStorage.getItem('daytale-theme');
      if(saved === 'light'){ document.body.classList.add('light-mode'); isDark = false; themeToggle.textContent = 'üåô Dark'; }
    })();

    // Draft + autosave indicator
    const saveStamp = () => {
      const ts = new Date();
      saveIndicator.textContent = `Saved ¬∑ ${ts.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
    };
    inputEl.addEventListener('input', () => {
      charCount.textContent = `${inputEl.value.length} characters`;
      localStorage.setItem('daytale-draft', inputEl.value);
      saveStamp();
    });
    (function restoreDraft(){
      const saved = localStorage.getItem('daytale-draft');
      if(saved){ inputEl.value = saved; charCount.textContent = `${saved.length} characters`; saveStamp(); }
    })();

    // Example prompts
    examplePrompts.forEach(p => p.addEventListener('click', () => {
      inputEl.value = p.dataset.text;
      charCount.textContent = `${inputEl.value.length} characters`;
      inputEl.focus();
      localStorage.setItem('daytale-draft', inputEl.value);
      saveStamp();
    }));

    // Prompt of the day
    const mentalPrompts = [
      "Name one feeling you noticed today and where you felt it in your body.",
      "What drained your energy and what restored it, even a little?",
      "Write about one boundary you protected or wish you had protected.",
      "A small moment of relief or gratitude you noticed today.",
      "If today had a headline, what would it be and why?",
      "What would you tell a friend who felt the way you did today?"
    ];
    promptBtn.addEventListener('click', () => {
      const pick = mentalPrompts[Math.floor(Math.random()*mentalPrompts.length)];
      inputEl.value = pick;
      charCount.textContent = `${pick.length} characters`;
      inputEl.focus();
      localStorage.setItem('daytale-draft', inputEl.value);
      saveStamp();
    });

    // Copy + Download
    copyBtn.addEventListener('click', async () => {
      try{ await navigator.clipboard.writeText(output.textContent); copyBtn.textContent='‚úÖ Copied'; setTimeout(()=>copyBtn.textContent='üìã Copy entry',1200);}
      catch(e){ console.error(e); }
    });
    downloadBtn.addEventListener('click', () => {
      const text = output.textContent.trim();
      if(!text){ alert('No entry yet.'); return; }
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `DayTale-${new Date().toISOString().slice(0,10)}.txt`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // Debounce helper
    function debounce(fn, wait=600){
      let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), wait); };
    }

    // Call backend API (your key will be server-side)
    async function callBackend(promptText){
      const res = await fetch('/api/generate', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ prompt: promptText })
      });
      if(!res.ok) {
        const msg = await res.text().catch(()=> '');
        throw new Error(`API ${res.status}: ${msg}`);
      }
      const data = await res.json();
      return (data.text || '').trim();
    }

    function styleToneInstructions(style, mood){
      const styleMap = {
        reflective: "Write a reflective, first-person entry that extracts one learning.",
        mindful: "Write a calm, present-focused reflection that notices sensations and breath.",
        therapeutic: "Write an introspective entry that validates feelings and suggests one gentle next step.",
        narrative: "Tell the day as a short scene with beginning, middle, end.",
        gratitude: "Surface 3 specific things to appreciate, avoiding generic praise.",
        snapshot: "Return 5 short bullet points: moments, feelings, one insight.",
        mantra: "Condense into one evocative line as a personal mantra."
      };
      const toneMap = {
        calm: "Keep the tone calm and steady.",
        compassionate: "Use compassionate, non-judgmental language.",
        honest: "Be candid without harshness.",
        hopeful: "Include a thread of hope and progress.",
        neutral: "Stay neutral and factual.",
        grounded: "Prefer concrete details over abstractions."
      };
      return `${styleMap[style]||styleMap.reflective} ${toneMap[mood]||toneMap.calm}`;
    }

    // Generate (debounced)
    const onTransform = debounce(async () => {
      const inputText = inputEl.value.trim();
      const style = styleEl.value;
      const mood = moodEl.value;
      if(!inputText){ alert('Please write some notes first.'); return; }

      loading.style.display = 'block';
      output.textContent = '';
      copyBtn.style.display = 'none';
      downloadBtn.style.display = 'none';
      shareBtn.style.display = 'none';
      candidatesWrap.style.display = 'none';
      candidatesEl.innerHTML = '';

      transformBtn.disabled = true;
      transformBtn.textContent = 'Creating...';

      const prompt = `Transform these notes into a mental health journal entry.\n${styleToneInstructions(style,mood)}\nKeep it human and grounded. Avoid clich√©s. If you suggest an action, keep it small and optional.\n\nNotes: "${inputText}"\n\nWrite the final entry:`;

      try{
        const result = await callBackend(prompt);
        output.textContent = result;
        copyBtn.style.display = 'inline-block';
        downloadBtn.style.display = 'inline-block';
        shareBtn.style.display = 'inline-block';

        const picks = getQuoteCandidates(result, 3);
        if (picks.length){
          candidatesWrap.style.display = 'block';
          picks.forEach((q,i)=>{
            const chip = document.createElement('button');
            chip.className = 'quote-chip';
            chip.textContent = q;
            chip.title = 'Click to select';
            chip.addEventListener('click', ()=>{
              [...candidatesEl.children].forEach(c=>c.classList.remove('active'));
              chip.classList.add('active'); selectedQuote = q;
            });
            if(i===0){ chip.classList.add('active'); selectedQuote = q; }
            candidatesEl.appendChild(chip);
          });
        }
      }catch(err){
        console.error(err);
        output.textContent = 'Error: ' + (err.message || 'Could not generate text.');
      }finally{
        loading.style.display = 'none';
        transformBtn.disabled = false;
        transformBtn.textContent = 'Create my journal entry';
      }
    }, 600);

    transformBtn.addEventListener('click', onTransform);
    inputEl.addEventListener('keydown', (e) => { if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)) onTransform(); });

    // Quote selection helpers (same as before)
    function getQuoteCandidates(text, k=3){
      const sents = text.split(/(?<=[.!?])\s+/).map(s=>s.trim()).filter(Boolean);
      if (!sents.length) return [];
      const emotive = /grateful|calm|breathe|relief|gentle|learn|hope|enough|grounded|small|step|tender|quiet|light|release|kind/i;
      const scores = sents.map((s, idx) => {
        let score = 0;
        const len = s.length;
        if (len>=80 && len<=220) score += 3;
        if (emotive.test(s)) score += 2;
        if (idx === sents.length-1 || idx === sents.length-2) score += 1;
        const words = s.toLowerCase().replace(/[^a-z\s]/g,'').split(/\s+/).filter(Boolean);
        const uniq = new Set(words).size / (words.length||1);
        score += uniq * 2;
        return { s, score };
      });
      return scores.sort((a,b)=>b.score-a).slice(0,k).map(o=>o.s.slice(0,300));
    }

    // Palettes + share image (unchanged except used fonts)
    const PALETTES = [
      {key:'dawn', name:'Dawn Sand', stops:['#f8f3e7','#e7d8b1'], stripe:'#dcc79b', text:'#1b1f29', badge:'#1b1f29'},
      {key:'mist', name:'Mist', stops:['#e6eef6','#cfd9e6'], stripe:'#c8d2e1', text:'#0b1020', badge:'#0b1020'},
      {key:'blush', name:'Blush', stops:['#ffe3e3','#ffd4c7'], stripe:'#ffd9cf', text:'#1f2937', badge:'#1f2937'},
      {key:'sage', name:'Sage', stops:['#e7f2ea','#cfe5d9'], stripe:'#d7eadf', text:'#16302a', badge:'#16302a'},
      {key:'lavender', name:'Lavender', stops:['#ece8ff','#dfd8ff'], stripe:'#e0d9ff', text:'#1e1b4b', badge:'#1e1b4b'},
      {key:'porcelain', name:'Porcelain', stops:['#fafafa','#ececec'], stripe:'#eeeeee', text:'#111827', badge:'#111827'},
      {key:'ink', name:'Ink', stops:['#0f172a','#1e293b'], stripe:'#334155', text:'#f1f5f9', badge:'#f1f5f9'}
    ];
    let activePalette = 'dawn';
    (function renderSwatches(){
      swatchBar.innerHTML = '';
      PALETTES.forEach(p=>{
        const b = document.createElement('button');
        b.className = 'swatch'; b.setAttribute('aria-label', p.name); b.setAttribute('data-name', p.name);
        b.style.background = `linear-gradient(135deg, ${p.stops[0]}, ${p.stops[1]})`;
        if (p.key === activePalette) b.classList.add('active');
        b.addEventListener('click', ()=>{
          activePalette = p.key;
          [...swatchBar.children].forEach(c=>c.classList.remove('active'));
          b.classList.add('active');
        });
        swatchBar.appendChild(b);
      });
    })();

    let selectedQuote = '';

    // Share
    shareBtn.addEventListener('click', async ()=>{
      const text = output.textContent.trim();
      if(!text){ alert('Generate an entry first.'); return; }
      if(!selectedQuote){
        const picks = getQuoteCandidates(text, 1);
        selectedQuote = picks[0] || text.slice(0,220);
      }
      quoteEdit.value = selectedQuote;
      await updatePreviewImage();
      openShareModal();
    });

    // Modal open/close + focus trap + Esc
    function openShareModal(){
      shareModal.classList.add('open');
      shareModal.setAttribute('aria-hidden','false');
      const focusable = modalCard.querySelectorAll('button, [href], input, textarea, select, [tabindex]:not([tabindex="-1"])');
      const first = focusable[0]; const last = focusable[focusable.length - 1];
      first?.focus();

      function trap(e){
        if(e.key === 'Tab'){
          if (e.shiftKey && document.activeElement === first){ last.focus(); e.preventDefault(); }
          else if (!e.shiftKey && document.activeElement === last){ first.focus(); e.preventDefault(); }
        }
        if(e.key === 'Escape'){ closeShareModal(); }
      }
      shareModal.addEventListener('keydown', trap);
      shareModal._trap = trap;
    }
    function closeShareModal(){
      shareModal.classList.remove('open');
      shareModal.setAttribute('aria-hidden','true');
      if (shareModal._trap){ shareModal.removeEventListener('keydown', shareModal._trap); shareModal._trap = null; }
      transformBtn.focus(); // return focus
    }

    shareCancel.addEventListener('click', closeShareModal);

    shareCopyQuote.addEventListener('click', async ()=>{
      try { await navigator.clipboard.writeText(quoteEdit.value.trim()); shareCopyQuote.textContent='‚úÖ Copied'; setTimeout(()=>shareCopyQuote.textContent='Copy quote',1200); }
      catch(e){ console.error(e); }
    });
    updatePreviewBtn.addEventListener('click', updatePreviewImage);

    async function updatePreviewImage(){
      const dataUrl = await createQuoteImage(quoteEdit.value.trim(), activePalette, true);
      sharePreview.src = dataUrl;
    }
    shareDownload.addEventListener('click', () => {
      const a = document.createElement('a');
      a.href = sharePreview.src;
      a.download = `DayTale-quote-${new Date().toISOString().slice(0,10)}.png`;
      document.body.appendChild(a); a.click(); a.remove();
    });
    shareDo.addEventListener('click', async () => {
      try{
        const resp = await fetch(sharePreview.src);
        const blob = await resp.blob();
        const file = new File([blob], 'daytale-quote.png', { type: 'image/png' });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({ files:[file], title:'DayTale Quote' });
        } else {
          const a = document.createElement('a'); a.href = sharePreview.src; a.download = 'daytale-quote.png';
          document.body.appendChild(a); a.click(); a.remove();
          alert('Sharing not supported here. Image downloaded instead.');
        }
      }catch(err){ console.error(err); alert('Share failed. Try downloading and posting manually.'); }
    });

    async function createQuoteImage(quote, paletteKey='dawn', includeLogo=true) {
      const style = (PALETTES.find(x=>x.key===paletteKey) || PALETTES[0]);
      const W = 1080, H = 1920;
      const canvas = document.createElement('canvas'); canvas.width = W; canvas.height = H;
      const ctx = canvas.getContext('2d');

      const grad = ctx.createLinearGradient(0, 0, W, H);
      grad.addColorStop(0, style.stops[0]); grad.addColorStop(1, style.stops[1]);
      ctx.fillStyle = grad; ctx.fillRect(0, 0, W, H);

      ctx.globalAlpha = 0.08;
      for (let i = 0; i < 22; i++) {
        ctx.fillStyle = i % 2 ? '#ffffff' : style.stripe;
        ctx.fillRect(-W, i * 80, W * 3, 2);
      }
      ctx.globalAlpha = 1;

      const marginX = 120, marginY = 240;

      // Badge (larger + centered)
      const badgeW = 340, badgeH = 72, badgeR = 18;
      const badgeX = (W - badgeW) / 2, badgeY = marginY - (badgeH + 12);
      ctx.fillStyle = 'rgba(0,0,0,0.12)'; roundRect(ctx, badgeX, badgeY, badgeW, badgeH, badgeR); ctx.fill();
      ctx.fillStyle = style.badge; ctx.font = '700 26px Arimo, sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText('My Quote of My Day', W/2, badgeY + badgeH/2);

      ctx.fillStyle = style.text; ctx.textAlign = 'left';
      let fontSize = 64; let wrapped;
      while (fontSize >= 40) {
        ctx.font = `800 ${fontSize}px Arimo, sans-serif`;
        wrapped = wrapText(ctx, quote, W - marginX*2, fontSize * 1.3);
        const blockHeight = wrapped.length * fontSize * 1.3;
        if (blockHeight <= H - marginY*2) break; fontSize -= 4;
      }
      const startY = (H - wrapped.length * fontSize * 1.3) / 2;
      let y = startY;
      for (const line of wrapped) { ctx.fillText(line, marginX, y); y += fontSize * 1.3; }

      if (includeLogo){
        const footerY = H - 140, logoSize = 72;
        ctx.fillStyle = 'rgba(255,255,255,0.9)';
        roundRect(ctx, marginX, footerY - logoSize, logoSize, logoSize, 16); ctx.fill();
        const img = await loadImage(BRAND_ICON_URL);
        ctx.save(); clipRoundRect(ctx, marginX, footerY - logoSize, logoSize, logoSize, 16);
        ctx.drawImage(img, marginX, footerY - logoSize, logoSize, logoSize); ctx.restore();

        ctx.textAlign = 'left'; ctx.fillStyle = '#111827';
        ctx.font = '800 32px "Cal Sans","Syne",sans-serif'; ctx.fillText('DayTale', marginX + logoSize + 18, footerY - 30);
        ctx.font = '600 20px Arimo, sans-serif'; ctx.fillStyle = 'rgba(17,24,39,.72)'; ctx.fillText('Mental health journaling', marginX + logoSize + 18, footerY);
      }

      return canvas.toDataURL('image/png');

      function roundRect(ctx, x, y, w, h, r){ const rr = typeof r==='number'?{tl:r,tr:r,br:r,bl:r}:r; ctx.beginPath(); ctx.moveTo(x+rr.tl,y); ctx.lineTo(x+w-rr.tr,y); ctx.quadraticCurveTo(x+w,y,x+w,y+rr.tr); ctx.lineTo(x+w,y+h-rr.br); ctx.quadraticCurveTo(x+w,y+h,x+w-rr.br,y+h); ctx.lineTo(x+rr.bl,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-rr.bl); ctx.lineTo(x,y+rr.tl); ctx.quadraticCurveTo(x,y,x+rr.tl,y); ctx.closePath(); }
      function clipRoundRect(ctx, x, y, w, h, r){ roundRect(ctx,x,y,w,h,r); ctx.clip(); }
      function wrapText(ctx, text, maxWidth){ const words=text.split(/\s+/); const lines=[]; let line=''; for(const w of words){ const test=line?line+' '+w:w; if(ctx.measureText(test).width<=maxWidth){ line=test; } else { if(line) lines.push(line); line=w; } } if(line) lines.push(line); return lines; }
      function loadImage(src){ return new Promise((resolve,reject)=>{ const im=new Image(); im.crossOrigin='anonymous'; im.onload=()=>resolve(im); im.onerror=reject; im.src=src; }); }
    }
  </script>
</body>
</html>