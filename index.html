<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DayTale - Transform Your Day Into Stories</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Arimo:ital,wght@0,400..700;1,400..700&family=Cal+Sans&family=Syne:wght@400..800&display=swap" rel="stylesheet">

  <style>
    /* (your full CSS unchanged) */
    .hint { font-size:.9rem; color:#cfcfd8; margin-top:.5rem; }
    .subhint { font-size:.82rem; color:#b7bac6; margin-top:.5rem; }
    .light-mode .hint { color:#444; }
    .light-mode .subhint { color:#555; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="logo-container">
        <div class="logo">
          <img src="https://i.ibb.co/kVyL1XmY/Gemini-Generated-Image-dvk7kidvk7kidvk7.png" alt="DayTale logo" />
        </div>
        <h1 class="app-title">DayTale</h1>
      </div>
      <p class="subtitle">Transform your scattered thoughts and daily moments into a grounded, compassionate journal entry.</p>
    </header>

    <div class="workspace">
      <!-- Left panel -->
      <div class="panel">
        <div class="panel-header">
          <h3 class="panel-title">Your Raw Day</h3>
          <button class="btn btn-secondary" id="theme-toggle">‚òÄÔ∏è Light</button>
        </div>

        <!-- New prime-the-writing hint -->
        <p class="hint">
          Take 2‚Äì3 minutes. Use ‚ÄúI‚Äù statements. Describe one thing that happened, how it felt in your body, and why it mattered.
        </p>
        <!-- New multilingual reassurance -->
        <p class="hint"><strong>You can write in any language ‚Äî try it!</strong></p>

        <div class="controls">
          <!-- (your writing style / tone selects unchanged) -->
        </div>

        <textarea id="input" aria-label="Write a few notes about your day" placeholder="A few notes... tired this morning, anxious before the meeting, walked at lunch, felt lighter after talking with a friend, cooked pasta at night"></textarea>

        <!-- New privacy reassurance -->
        <p class="subhint">We don‚Äôt store entries. Text is processed to generate your draft, then discarded.</p>

        <button class="btn btn-primary transform-btn" id="transform">‚ú® Craft My Journal Entry</button>

        <!-- (your example prompts unchanged) -->
      </div>

      <!-- Right panel -->
      <div class="panel">
        <div class="panel-header">
          <h3 class="panel-title">Your Journal Entry</h3>
          <div>
            <button class="btn btn-secondary" id="copy-btn" style="display:none;">üìã Copy</button>
          </div>
        </div>

        <div class="loading" id="loading" style="display:none;">Weaving your day into a story... ‚ú®</div>
        <div class="output" id="output">
          Your transformed journal entry will appear here.
        </div>
      </div>
    </div>
  </div>

  <script>
    // -------------------------
    // CONFIG
    // -------------------------
    const BRAND_ICON_URL = 'https://i.ibb.co/kVyL1XmY/Gemini-Generated-Image-dvk7kidvk7kidvk7.png';

    // -------------------------
    // ELEMENTS
    // -------------------------
    const themeToggle = document.getElementById('theme-toggle');
    const inputEl = document.getElementById('input');
    const styleEl = document.getElementById('style');
    const moodEl = document.getElementById('mood');
    const charCount = document.getElementById('char-count');
    const saveIndicator = document.getElementById('save-indicator');
    const transformBtn = document.getElementById('transform');
    const loading = document.getElementById('loading');
    const output = document.getElementById('output');
    const copyBtn = document.getElementById('copy-btn');
    const downloadBtn = document.getElementById('download-btn');
    const shareBtn = document.getElementById('share-btn');
    const swatchBar = document.getElementById('swatch-bar');
    const candidatesWrap = document.getElementById('candidates-wrap');
    const candidatesEl = document.getElementById('quote-candidates');
    const promptBtn = document.getElementById('prompt-btn');
    const examplePrompts = document.querySelectorAll('.example-prompt');

    // Modal
    const shareModal = document.getElementById('share-modal');
    const modalCard = shareModal.querySelector('.modal-card');
    const sharePreview = document.getElementById('share-preview');
    const shareCancel = document.getElementById('share-cancel');
    const shareDownload = document.getElementById('share-download');
    const shareDo = document.getElementById('share-do');
    const shareCopyQuote = document.getElementById('share-copyquote');
    const quoteEdit = document.getElementById('quote-edit');
    const includeLogoEl = document.getElementById('include-logo');
    const updatePreviewBtn = document.getElementById('update-preview');

    // Subtitle rotator
    const subtitleLines = Array.from(document.querySelectorAll('.rotator-line'));
    let rotIdx = 0;
    setInterval(() => {
      rotIdx = (rotIdx + 1) % subtitleLines.length;
      subtitleLines.forEach((el,i) => el.classList.toggle('active', i === rotIdx));
    }, 3200);

    // Theme
    let isDark = true;
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('light-mode');
      isDark = !isDark;
      themeToggle.textContent = isDark ? '‚òÄÔ∏è Light' : 'üåô Dark';
      localStorage.setItem('daytale-theme', isDark ? 'dark' : 'light');
    });
    (function restoreTheme(){
      const saved = localStorage.getItem('daytale-theme');
      if(saved === 'light'){ document.body.classList.add('light-mode'); isDark = false; themeToggle.textContent = 'üåô Dark'; }
    })();

    // Draft + autosave indicator
    const saveStamp = () => {
      const ts = new Date();
      saveIndicator.textContent = `Saved ¬∑ ${ts.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
    };
    inputEl.addEventListener('input', () => {
      charCount.textContent = `${inputEl.value.length} characters`;
      localStorage.setItem('daytale-draft', inputEl.value);
      saveStamp();
    });
    (function restoreDraft(){
      const saved = localStorage.getItem('daytale-draft');
      if(saved){ inputEl.value = saved; charCount.textContent = `${saved.length} characters`; saveStamp(); }
    })();

    // Example prompts
    examplePrompts.forEach(p => p.addEventListener('click', () => {
      inputEl.value = p.dataset.text;
      charCount.textContent = `${inputEl.value.length} characters`;
      inputEl.focus();
      localStorage.setItem('daytale-draft', inputEl.value);
      saveStamp();
    }));

    // Prompt of the day
    const mentalPrompts = [
      "Name one feeling you noticed today and where you felt it in your body.",
      "What drained your energy and what restored it, even a little?",
      "Write about one boundary you protected or wish you had protected.",
      "A small moment of relief or gratitude you noticed today.",
      "If today had a headline, what would it be and why?",
      "What would you tell a friend who felt the way you did today?"
    ];
    promptBtn.addEventListener('click', () => {
      const pick = mentalPrompts[Math.floor(Math.random()*mentalPrompts.length)];
      inputEl.value = pick;
      charCount.textContent = `${pick.length} characters`;
      inputEl.focus();
      localStorage.setItem('daytale-draft', inputEl.value);
      saveStamp();
    });

    // Copy + Download
    copyBtn.addEventListener('click', async () => {
      try{ await navigator.clipboard.writeText(output.textContent); copyBtn.textContent='‚úÖ Copied'; setTimeout(()=>copyBtn.textContent='üìã Copy entry',1200);}
      catch(e){ console.error(e); }
    });
    downloadBtn.addEventListener('click', () => {
      const text = output.textContent.trim();
      if(!text){ alert('No entry yet.'); return; }
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `DayTale-${new Date().toISOString().slice(0,10)}.txt`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // Debounce helper
    function debounce(fn, wait=600){
      let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), wait); };
    }

    // Call backend API (your key will be server-side)
    async function callBackend(promptText){
      const res = await fetch('/api/generate', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ prompt: promptText })
      });
      if(!res.ok) {
        const msg = await res.text().catch(()=> '');
        throw new Error(`API ${res.status}: ${msg}`);
      }
      const data = await res.json();
      return (data.text || '').trim();
    }

    function styleToneInstructions(style, mood){
      const styleMap = {
        reflective: "Write a reflective, first-person entry that extracts one learning.",
        mindful: "Write a calm, present-focused reflection that notices sensations and breath.",
        therapeutic: "Write an introspective entry that validates feelings and suggests one gentle next step.",
        narrative: "Tell the day as a short scene with beginning, middle, end.",
        gratitude: "Surface 3 specific things to appreciate, avoiding generic praise.",
        snapshot: "Return 5 short bullet points: moments, feelings, one insight.",
        mantra: "Condense into one evocative line as a personal mantra."
      };
      const toneMap = {
        calm: "Keep the tone calm and steady.",
        compassionate: "Use compassionate, non-judgmental language.",
        honest: "Be candid without harshness.",
        hopeful: "Include a thread of hope and progress.",
        neutral: "Stay neutral and factual.",
        grounded: "Prefer concrete details over abstractions."
      };
      return `${styleMap[style]||styleMap.reflective} ${toneMap[mood]||toneMap.calm}`;
    }

    // Generate (debounced)
    const onTransform = debounce(async () => {
      const inputText = inputEl.value.trim();
      const style = styleEl.value;
      const mood = moodEl.value;
      if(!inputText){ alert('Please write some notes first.'); return; }

      loading.style.display = 'block';
      output.textContent = '';
      copyBtn.style.display = 'none';
      downloadBtn.style.display = 'none';
      shareBtn.style.display = 'none';
      candidatesWrap.style.display = 'none';
      candidatesEl.innerHTML = '';

      transformBtn.disabled = true;
      transformBtn.textContent = 'Creating...';

      const prompt = `Transform these notes into a mental health journal entry.\n${styleToneInstructions(style,mood)}\nKeep it human and grounded. Avoid clich√©s. If you suggest an action, keep it small and optional.\n\nNotes: "${inputText}"\n\nWrite the final entry:`;

      try{
        const result = await callBackend(prompt);
        output.textContent = result;
        copyBtn.style.display = 'inline-block';
        downloadBtn.style.display = 'inline-block';
        shareBtn.style.display = 'inline-block';

        const picks = getQuoteCandidates(result, 3);
        if (picks.length){
          candidatesWrap.style.display = 'block';
          picks.forEach((q,i)=>{
            const chip = document.createElement('button');
            chip.className = 'quote-chip';
            chip.textContent = q;
            chip.title = 'Click to select';
            chip.addEventListener('click', ()=>{
              [...candidatesEl.children].forEach(c=>c.classList.remove('active'));
              chip.classList.add('active'); selectedQuote = q;
            });
            if(i===0){ chip.classList.add('active'); selectedQuote = q; }
            candidatesEl.appendChild(chip);
          });
        }
      }catch(err){
        console.error(err);
        output.textContent = 'Error: ' + (err.message || 'Could not generate text.');
      }finally{
        loading.style.display = 'none';
        transformBtn.disabled = false;
        transformBtn.textContent = 'Create my journal entry';
      }
    }, 600);

    transformBtn.addEventListener('click', onTransform);
    inputEl.addEventListener('keydown', (e) => { if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)) onTransform(); });

    // Quote selection helpers (same as before)
    function getQuoteCandidates(text, k=3){
      const sents = text.split(/(?<=[.!?])\s+/).map(s=>s.trim()).filter(Boolean);
      if (!sents.length) return [];
      const emotive = /grateful|calm|breathe|relief|gentle|learn|hope|enough|grounded|small|step|tender|quiet|light|release|kind/i;
      const scores = sents.map((s, idx) => {
        let score = 0;
        const len = s.length;
        if (len>=80 && len<=220) score += 3;
        if (emotive.test(s)) score += 2;
        if (idx === sents.length-1 || idx === sents.length-2) score += 1;
        const words = s.toLowerCase().replace(/[^a-z\s]/g,'').split(/\s+/).filter(Boolean);
        const uniq = new Set(words).size / (words.length||1);
        score += uniq * 2;
        return { s, score };
      });
      return scores.sort((a,b)=>b.score-a).slice(0,k).map(o=>o.s.slice(0,300));
    }

    // Palettes + share image (unchanged except used fonts)
    const PALETTES = [
      {key:'dawn', name:'Dawn Sand', stops:['#f8f3e7','#e7d8b1'], stripe:'#dcc79b', text:'#1b1f29', badge:'#1b1f29'},
      {key:'mist', name:'Mist', stops:['#e6eef6','#cfd9e6'], stripe:'#c8d2e1', text:'#0b1020', badge:'#0b1020'},
      {key:'blush', name:'Blush', stops:['#ffe3e3','#ffd4c7'], stripe:'#ffd9cf', text:'#1f2937', badge:'#1f2937'},
      {key:'sage', name:'Sage', stops:['#e7f2ea','#cfe5d9'], stripe:'#d7eadf', text:'#16302a', badge:'#16302a'},
      {key:'lavender', name:'Lavender', stops:['#ece8ff','#dfd8ff'], stripe:'#e0d9ff', text:'#1e1b4b', badge:'#1e1b4b'},
      {key:'porcelain', name:'Porcelain', stops:['#fafafa','#ececec'], stripe:'#eeeeee', text:'#111827', badge:'#111827'},
      {key:'ink', name:'Ink', stops:['#0f172a','#1e293b'], stripe:'#334155', text:'#f1f5f9', badge:'#f1f5f9'}
    ];
    let activePalette = 'dawn';
    (function renderSwatches(){
      swatchBar.innerHTML = '';
      PALETTES.forEach(p=>{
        const b = document.createElement('button');
        b.className = 'swatch'; b.setAttribute('aria-label', p.name); b.setAttribute('data-name', p.name);
        b.style.background = `linear-gradient(135deg, ${p.stops[0]}, ${p.stops[1]})`;
        if (p.key === activePalette) b.classList.add('active');
        b.addEventListener('click', ()=>{
          activePalette = p.key;
          [...swatchBar.children].forEach(c=>c.classList.remove('active'));
          b.classList.add('active');
        });
        swatchBar.appendChild(b);
      });
    })();

    let selectedQuote = '';

    // Share
    shareBtn.addEventListener('click', async ()=>{
      const text = output.textContent.trim();
      if(!text){ alert('Generate an entry first.'); return; }
      if(!selectedQuote){
        const picks = getQuoteCandidates(text, 1);
        selectedQuote = picks[0] || text.slice(0,220);
      }
      quoteEdit.value = selectedQuote;
      await updatePreviewImage();
      openShareModal();
    });

    // Modal open/close + focus trap + Esc
    function openShareModal(){
      shareModal.classList.add('open');
      shareModal.setAttribute('aria-hidden','false');
      const focusable = modalCard.querySelectorAll('button, [href], input, textarea, select, [tabindex]:not([tabindex="-1"])');
      const first = focusable[0]; const last = focusable[focusable.length - 1];
      first?.focus();

      function trap(e){
        if(e.key === 'Tab'){
          if (e.shiftKey && document.activeElement === first){ last.focus(); e.preventDefault(); }
          else if (!e.shiftKey && document.activeElement === last){ first.focus(); e.preventDefault(); }
        }
        if(e.key === 'Escape'){ closeShareModal(); }
      }
      shareModal.addEventListener('keydown', trap);
      shareModal._trap = trap;
    }
    function closeShareModal(){
      shareModal.classList.remove('open');
      shareModal.setAttribute('aria-hidden','true');
      if (shareModal._trap){ shareModal.removeEventListener('keydown', shareModal._trap); shareModal._trap = null; }
      transformBtn.focus(); // return focus
    }

    shareCancel.addEventListener('click', closeShareModal);

    shareCopyQuote.addEventListener('click', async ()=>{
      try { await navigator.clipboard.writeText(quoteEdit.value.trim()); shareCopyQuote.textContent='‚úÖ Copied'; setTimeout(()=>shareCopyQuote.textContent='Copy quote',1200); }
      catch(e){ console.error(e); }
    });
    updatePreviewBtn.addEventListener('click', updatePreviewImage);

    async function updatePreviewImage(){
      const dataUrl = await createQuoteImage(quoteEdit.value.trim(), activePalette, true);
      sharePreview.src = dataUrl;
    }
    shareDownload.addEventListener('click', () => {
      const a = document.createElement('a');
      a.href = sharePreview.src;
      a.download = `DayTale-quote-${new Date().toISOString().slice(0,10)}.png`;
      document.body.appendChild(a); a.click(); a.remove();
    });
    shareDo.addEventListener('click', async () => {
      try{
        const resp = await fetch(sharePreview.src);
        const blob = await resp.blob();
        const file = new File([blob], 'daytale-quote.png', { type: 'image/png' });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({ files:[file], title:'DayTale Quote' });
        } else {
          const a = document.createElement('a'); a.href = sharePreview.src; a.download = 'daytale-quote.png';
          document.body.appendChild(a); a.click(); a.remove();
          alert('Sharing not supported here. Image downloaded instead.');
        }
      }catch(err){ console.error(err); alert('Share failed. Try downloading and posting manually.'); }
    });

    async function createQuoteImage(quote, paletteKey='dawn', includeLogo=true) {
      const style = (PALETTES.find(x=>x.key===paletteKey) || PALETTES[0]);
      const W = 1080, H = 1920;
      const canvas = document.createElement('canvas'); canvas.width = W; canvas.height = H;
      const ctx = canvas.getContext('2d');

      const grad = ctx.createLinearGradient(0, 0, W, H);
      grad.addColorStop(0, style.stops[0]); grad.addColorStop(1, style.stops[1]);
      ctx.fillStyle = grad; ctx.fillRect(0, 0, W, H);

      ctx.globalAlpha = 0.08;
      for (let i = 0; i < 22; i++) {
        ctx.fillStyle = i % 2 ? '#ffffff' : style.stripe;
        ctx.fillRect(-W, i * 80, W * 3, 2);
      }
      ctx.globalAlpha = 1;

      const marginX = 120, marginY = 240;

      // Badge (larger + centered)
      const badgeW = 340, badgeH = 72, badgeR = 18;
      const badgeX = (W - badgeW) / 2, badgeY = marginY - (badgeH + 12);
      ctx.fillStyle = 'rgba(0,0,0,0.12)'; roundRect(ctx, badgeX, badgeY, badgeW, badgeH, badgeR); ctx.fill();
      ctx.fillStyle = style.badge; ctx.font = '700 26px Arimo, sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText('My Quote of My Day', W/2, badgeY + badgeH/2);

      ctx.fillStyle = style.text; ctx.textAlign = 'left';
      let fontSize = 64; let wrapped;
      while (fontSize >= 40) {
        ctx.font = `800 ${fontSize}px Arimo, sans-serif`;
        wrapped = wrapText(ctx, quote, W - marginX*2, fontSize * 1.3);
        const blockHeight = wrapped.length * fontSize * 1.3;
        if (blockHeight <= H - marginY*2) break; fontSize -= 4;
      }
      const startY = (H - wrapped.length * fontSize * 1.3) / 2;
      let y = startY;
      for (const line of wrapped) { ctx.fillText(line, marginX, y); y += fontSize * 1.3; }

      if (includeLogo){
        const footerY = H - 140, logoSize = 72;
        ctx.fillStyle = 'rgba(255,255,255,0.9)';
        roundRect(ctx, marginX, footerY - logoSize, logoSize, logoSize, 16); ctx.fill();
        const img = await loadImage(BRAND_ICON_URL);
        ctx.save(); clipRoundRect(ctx, marginX, footerY - logoSize, logoSize, logoSize, 16);
        ctx.drawImage(img, marginX, footerY - logoSize, logoSize, logoSize); ctx.restore();

        ctx.textAlign = 'left'; ctx.fillStyle = '#111827';
        ctx.font = '800 32px "Cal Sans","Syne",sans-serif'; ctx.fillText('DayTale', marginX + logoSize + 18, footerY - 30);
        ctx.font = '600 20px Arimo, sans-serif'; ctx.fillStyle = 'rgba(17,24,39,.72)'; ctx.fillText('Mental health journaling', marginX + logoSize + 18, footerY);
      }

      return canvas.toDataURL('image/png');

      function roundRect(ctx, x, y, w, h, r){ const rr = typeof r==='number'?{tl:r,tr:r,br:r,bl:r}:r; ctx.beginPath(); ctx.moveTo(x+rr.tl,y); ctx.lineTo(x+w-rr.tr,y); ctx.quadraticCurveTo(x+w,y,x+w,y+rr.tr); ctx.lineTo(x+w,y+h-rr.br); ctx.quadraticCurveTo(x+w,y+h,x+w-rr.br,y+h); ctx.lineTo(x+rr.bl,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-rr.bl); ctx.lineTo(x,y+rr.tl); ctx.quadraticCurveTo(x,y,x+rr.tl,y); ctx.closePath(); }
      function clipRoundRect(ctx, x, y, w, h, r){ roundRect(ctx,x,y,w,h,r); ctx.clip(); }
      function wrapText(ctx, text, maxWidth){ const words=text.split(/\s+/); const lines=[]; let line=''; for(const w of words){ const test=line?line+' '+w:w; if(ctx.measureText(test).width<=maxWidth){ line=test; } else { if(line) lines.push(line); line=w; } } if(line) lines.push(line); return lines; }
      function loadImage(src){ return new Promise((resolve,reject)=>{ const im=new Image(); im.crossOrigin='anonymous'; im.onload=()=>resolve(im); im.onerror=reject; im.src=src; }); }
    }
  </script>
</body>
</html>
